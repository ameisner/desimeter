#!/usr/bin/env python

import sys
import numpy as np
import matplotlib.pyplot as plt
from astropy.table import Table

from desimeter.transform.pos2ptl import int2loc,loc2flat


import argparse
parser = argparse.ArgumentParser(description=__doc__)
parser.add_argument('-i', '--infile', type=str, required=True, 
                    help='path to input csv file like M02012.csv')

args = parser.parse_args()

filename=args.infile
t=Table.read(filename)
print(t.dtype.names)


#plt.figure()
#plt.hist(t['DELTAT'],bins=100)

ok=t["OFFSET_T"]!=0
t=t[:][ok]
x_flat = np.zeros(t["POS_T"].size)
y_flat = np.zeros(t["POS_T"].size)
for i in range(t["POS_T"].size) :
   x_loc, y_loc = int2loc(t["POS_T"][i],t["POS_P"][i], t['LENGTH_R1'][i], t['LENGTH_R2'][i] , t['OFFSET_T'][i] , t['OFFSET_P'][i])
   x_flat[i] = loc2flat(x_loc,t['OFFSET_X'][i])
   y_flat[i] = loc2flat(y_loc,t['OFFSET_Y'][i])

x_fp=t["X_FP"]
y_fp=t["Y_FP"]

#plt.figure('T_STAMP')
#plt.plot(t['TSTAMP_POSMOVE'],t['TSTAMP_FVC'],"o")
#plt.plot(t['DELTAT'],t['TSTAMP_FVC']-t['TSTAMP_POSMOVE'],"o")

name=t['POS_ID'][0]

plt.figure(name+"-1")
plt.subplot(211,title=name)
plt.plot(x_flat,x_fp,"o")
plt.xlabel("expected X(THETA,PHI) (mm)")
plt.ylabel("desimeter measured X (mm)")
plt.subplot(212)
plt.plot(y_flat,y_fp,"o")
plt.xlabel("expected Y(THETA,PHI) (mm)")
plt.ylabel("desimeter measured Y (mm)")

plt.figure(name)
a=plt.subplot(111,title=name)
plt.plot(x_fp,y_fp,"o",label="measured with desimeter")
plt.plot(x_flat,y_flat,"x",label="expected from posmove db")
plt.xlabel("X (mm)")
plt.ylabel("Y (mm)")
plt.legend()

plt.show()
